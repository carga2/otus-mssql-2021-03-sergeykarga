EXEC sp_configure 'show advanced options', 1
RECONFIGURE;
EXEC sp_configure 'clr enabled', 1
RECONFIGURE;
EXEC sp_configure 'clr strict security', 0
RECONFIGURE;
ALTER DATABASE [WideWorldImporters] SET TRUSTWORTHY ON;

-- функция преобразует текст, передаваемый в параметр @text в UTF-8 и сохраняет в файл с именем @file_name, по пути @file_path и расширением @file_exten. @rewrite - перезаписать файл или нет
CREATE ASSEMBLY [assemblyName]
FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C01030070EFF9980000000000000000E00022200B013000001400000006000000000000B23200000020000000400000000000100020000000020000040000000000000006000000000000000080000000020000000000000300608500001000001000000000100000100000000000001000000000000000000000005D3200004F00000000400000BC03000000000000000000000000000000000000006000000C000000A8310000380000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000B8120000002000000014000000020000000000000000000000000000200000602E72737263000000BC030000004000000004000000160000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001A000000000000000000000000000040000042000000000000000000000000000000009132000000000000480000000200050018230000900E000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001B300500E9010000010000110005731100000A0D09281200000A13041104281300000A13050002281400000A130611062C0D0072010000700A00385801000003281400000A130711072C0D0072410000700A00383F01000004281400000A130811082C0D0072810000700A00382601000005281400000A130911092C0D0072CB0000700A00380D01000000110572EF000070281500000A6F1600000A7E02000004252D17267E01000004FE0604000006731700000A258002000004280100002B731900000A7E03000004252D17267E01000004FE0605000006731A00000A2580030000047E04000004252D17267E01000004FE0606000006731B00000A258004000004280200002B0B16731D00000A130A281E00000A076F1F00000A0C110A086F2000000A0A001B8D1F000001251602A2251772FB000070A2251803A2251972FF000070A2251A04A2282100000A130B0E04172E03162B0117130C110B110C110A732200000A130D00110D066F2300000A0000DE0D110D2C08110D6F2400000A00DC7203010070110B282500000A0A00DE042600FE1A0000DE3A130E00110E6F2600000A0A02722F010070282500000A732700000A130F00110F066F2300000A0000DE0D110F2C08110F6F2400000A00DC00DE00DE1200096F2800000A0011046F2900000A0000DC06732A00000A13102B0011102A000000417C0000020000005C0100000D000000690100000D00000000000000000000001A0100006C00000086010000040000001000000102000000AB0100000D000000B80100000D000000000000000000000019000000750100008E0100003A000000190000010200000019000000B1010000CA01000012000000000000002E730300000680010000042A2202282B00000A002AAA726701007003726F010070281500000A6F2C00000A282D00000A282E00000A282F00000A282500000A2A2203046F3000000A2A1E036F3100000A2A00000042534A4201000100000000000C00000076342E302E33303331390000000005006C00000038040000237E0000A40400006405000023537472696E677300000000080A00008001000023555300880B0000100000002347554944000000980B0000F802000023426C6F620000000000000002000001571D0208090A000000FA013300160000010000002800000003000000040000000600000009000000310000000100000010000000010000000300000001000000050000000100000002000000000092030100000000000600A702A90406001403A9040600C60177040F00C90400000600EE01C40306008A02C40306005602C4030600FB02C4030600C702C4030600E002C40306000502C4030600DA018A040600B8018A0406003902C403060020023F0306000D05AF030A0075024F040A000A014F040A005903D80406001304B0000E000904A40312003305E00306003603480506003704B0000600D603AF0306009D01A90406006F00AF0306007600AF0306001E0448050600FC03B00006007F03AF0312004801E00312002C04E00306004100E30016002501F00306003203480506004404B00006003001AF0312009201E00306003C05AF0300000000A700000000000100010081011000C600000041000100010003211000DF0000004100010002003600A3001D01160001002101160021002A0116004F003501502000000000960086003E010100C422000000009118700448010600D0220000000086186A0406000600D9220000000083000A004C01060004230000000083002A00520107000D2300000000830058005A010900000001008603000002004E0100000300B603000004006C03101005003C01000001008F0300000100DC0000000200FD0400000100DC0009006A04010011006A04060019006A040A0029006A04100031006A04100039006A04100041006A04100049006A04100051006A04100059006A04100061006A04150069006A04100071006A04100079006A04100089006A040600D1006A040600F1006A041000A90081013700B100FE003E00F9005405450001011B054A000901F60451000C006A046600190114056C00E9006A04060014006A0466001C006A046600190188019E0021016A041500B9007D00C600B900ED04CB00B9007C03D100F900FF04D700C1006A04DD00290157011000310179010600F900FF04E500C9001901EB00C1006A041000A10079010600A9007901060099006A04100081006A040600B1002803EF0039012705F800F9000605FF00410161010501E9000301090181006303EB0008001500180120007B005F022E000B0060012E00130069012E001B0088012E00230091012E002B00A4012E003300A4012E003B00AA012E00430091012E004B00B9012E005300A4012E005B00A4012E006300DA012E006B0004022E007300110263008300F0021A005E008C009600048000000100000000000000000000000000950000000400000000000000000000000F01D300000000000400000000000000000000000F01BA00000000000400000000000000000000000F01A403000000000400000000000000000000000F01E003000000000400000000000000000000000F016D010000000003000200310086003900BF0000000000003C3E395F5F305F30003C5361766546696C65546F555446383E625F5F305F30003C3E395F5F305F31003C5361766546696C65546F555446383E625F5F305F310049456E756D657261626C656031003C3E395F5F305F32003C5361766546696C65546F555446383E625F5F305F320046756E6360320046756E636033006765745F55544638005361766546696C65546F5554463800586D6C546F46696C6555746638003C3E39003C4D6F64756C653E0053797374656D2E494F0053797374656D2E44617461005472616E7366657244617461006D73636F726C6962007362003C3E630053797374656D2E436F6C6C656374696F6E732E47656E65726963004C6F616400417070656E6400446174614163636573734B696E64006765745F4D65737361676500456E756D657261626C650049446973706F7361626C65007265777269746546696C6500584E616D650066696C654E616D650057726974654C696E65006765745F4E65774C696E650053797374656D2E436F726500446973706F73650043726561746500416767726567617465005841747472696275746500436F6D70696C657247656E65726174656441747472696275746500477569644174747269627574650044656275676761626C6541747472696275746500436F6D56697369626C6541747472696275746500417373656D626C795469746C6541747472696275746500417373656D626C7954726164656D61726B417474726962757465005461726765744672616D65776F726B41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E4174747269627574650053716C46756E6374696F6E41747472696275746500417373656D626C794465736372697074696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C79436F6D70616E794174747269627574650052756E74696D65436F6D7061746962696C6974794174747269627574650055544638456E636F64696E670053797374656D2E52756E74696D652E56657273696F6E696E670053716C537472696E6700546F537472696E6700786D6C446174614173537472696E6700476574537472696E670066696C655061746800656C00586D6C546F46696C65557466382E646C6C0053797374656D2E586D6C0053797374656D0066696C65457874656E73696F6E0053797374656D2E5265666C656374696F6E00457863657074696F6E0053797374656D2E586D6C2E4C696E710053797374656D2E4C696E7100537472696E6752656164657200586D6C526561646572005465787452656164657200537472696E674275696C6465720058436F6E7461696E65720053747265616D5772697465720054657874577269746572004D6963726F736F66742E53716C5365727665722E536572766572002E63746F72002E6363746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E496E7465726F7053657276696365730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053797374656D2E446174612E53716C547970657300476574427974657300456C656D656E747300436F6E63617400466F726D6174004F626A6563740053656C656374006F705F496D706C69636974006F705F4578706C696369740058456C656D656E7400456E7669726F6E6D656E740053797374656D2E546578740049734E756C6C4F72456D707479000000003F4E0055004C004C0020006F007200200065006D007000740079002000660069006C006500200070006100740068002000690073002000730065006E006400003F4E0055004C004C0020006F007200200065006D007000740079002000660069006C00650020006E0061006D0065002000690073002000730065006E00640000494E0055004C004C0020006F007200200065006D007000740079002000660069006C006500200065007800740065006E00730069006F006E002000690073002000730065006E006400002345006D0070007400790020006400610074006100200073007400720069006E006700000B4200610074006300680000035C0000032E00002B5400680065002000660069006C006500200069007300200073006100760065006400200069006E00200000375C004500720072006F0072004C006F0067005F0045007800630065006C00500061007300730070006F00720074002E0074007800740000077B0030007D00000F45006C0065006D0065006E0074000000CE4EDE850F93894DB7379C8C591EDDA900042001010803200001052001011111042001010E04200101021C07110E0E1D0512511255125902020202125D0E02126112651261114D0600011255125106000112591255040001020E0600011280810E0C2001151280890112591280810715126D0212590E052002011C181910020215128089011E0115128089011E0015126D021E001E01050A0212590E091512710312750E12750715126D0212750E201003041E0215128089011E001E01151271031E011E001E0115126D021E011E02060A030E12750E040000125D0520011D050E0520010E1D050500010E1D0E072003010E02125D0500020E0E0E0320000E08200112809D1280810600010E12809D0500020E0E1C0300000E05200112750E08B77A5C561934E08904000000000306120C080615126D0212590E0A061512710312750E1275080615126D0212750E090005114D0E0E0E0E08030000010520010E1259072002127512750E0520010E12750801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010801000701000000001201000D586D6C546F46696C655574663800000501000000000E0100094D6963726F736F667400002001001B436F7079726967687420C2A9204D6963726F736F6674203230313900002901002430323231323331312D656564642D346132332D623863352D64323339353838623833353900000C010007312E302E302E3000004D01001C2E4E45544672616D65776F726B2C56657273696F6E3D76342E372E320100540E144672616D65776F726B446973706C61794E616D65142E4E4554204672616D65776F726B20342E372E32808F010001005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D342E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000004010000000000000000000038AE9E8A00000000020000007D000000E0310000E013000000000000000000000000000010000000000000000000000000000000525344539D330CFD78BA384C880AEEFF2EA0EC7A01000000443A5CD0A0D0B0D0B7D180D0B0D0B1D0BED182D0BAD0B05CD09DD097D0A5D09A5C56535F50726F6A656374735C586D6C546F46696C65557466385C586D6C546F46696C65557466385C6F626A5C44656275675C586D6C546F46696C65557466382E706462008532000000000000000000009F32000000200000000000000000000000000000000000000000000091320000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000000000FF25002000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000600300000000000000000000600334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000000000000000100000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004C0020000010053007400720069006E006700460069006C00650049006E0066006F0000009C02000001003000300030003000300034006200300000001A000100010043006F006D006D0065006E007400730000000000000034000A00010043006F006D00700061006E0079004E0061006D006500000000004D006900630072006F0073006F0066007400000044000E000100460069006C0065004400650073006300720069007000740069006F006E000000000058006D006C0054006F00460069006C00650055007400660038000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E003000000044001200010049006E007400650072006E0061006C004E0061006D006500000058006D006C0054006F00460069006C00650055007400660038002E0064006C006C0000005A001B0001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020004D006900630072006F0073006F006600740020003200300031003900000000002A00010001004C006500670061006C00540072006100640065006D00610072006B00730000000000000000004C00120001004F0072006900670069006E0061006C00460069006C0065006E0061006D006500000058006D006C0054006F00460069006C00650055007400660038002E0064006C006C0000003C000E000100500072006F0064007500630074004E0061006D0065000000000058006D006C0054006F00460069006C00650055007400660038000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000B43200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
WITH PERMISSION_SET = SAFE
GO

CREATE FUNCTION dbo.SaveFileToUTF8(@file_path nvarchar(200), @file_name nvarchar(200), @file_exten nvarchar(6), @text nvarchar(max), @rewrite int)
RETURNS nvarchar(4000) WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME assemblyName.TransferData.SaveFileToUTF8
go

declare @Direct nvarchar(200)
	, @FileName nvarchar(200) = 'TestFile'
	, @xmlAsText nvarchar(max) = N'<Elements>  
                                    <_x0023_xml Element = "INPUT_BATCH_001       00000000000000000041        003489    Пружина" />
                                    <_x0023_xml Element = "INPUT_BATCH_001       00000000000000000042        003450    Пружина" />
                                    <_x0023_xml Element = "INPUT_BATCH_001       00000000000000000043        003451    Пружина" />
                                    <_x0023_xml Element = "INPUT_BATCH_001       00000000000000000044        003452    Пружина" />
                                    <_x0023_xml Element = "INPUT_BATCH_001       00000000000000000045        003453    Пружина" />
                                    </Elements >'

SET @Direct = N'D:\'
EXEC dbo.SaveFileToUTF8 @Direct, @FileName, N'APP', @xmlAsText, 0